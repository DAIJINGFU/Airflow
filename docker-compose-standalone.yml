# Airflow 3.x Standalone 简化版本
# 自动创建用户并运行所有组件

services:
  airflow-standalone:
    image: airflow-quant:3.1.3
    environment:
      - AIRFLOW__CORE__LOAD_EXAMPLES=false
      - AIRFLOW__CORE__AUTH_MANAGER=airflow.providers.fab.auth_manager.fab_auth_manager.FabAuthManager
      - AIRFLOW__WEBSERVER__EXPOSE_CONFIG=true
      # Execution API 在 Airflow 3.x 中负责调度器与任务进程通信，默认 5s 容易超时
      - AIRFLOW__WORKERS__EXECUTION_API_TIMEOUT=30
      # 固定管理员密码（Standalone模式专用变量）
      - _AIRFLOW_WWW_USER_CREATE=True
      - _AIRFLOW_WWW_USER_USERNAME=admin
      - _AIRFLOW_WWW_USER_PASSWORD=airflow2025
      - _AIRFLOW_WWW_USER_FIRSTNAME=Admin
      - _AIRFLOW_WWW_USER_LASTNAME=User
      - _AIRFLOW_WWW_USER_EMAIL=admin@example.com
      - _AIRFLOW_WWW_USER_ROLE=Admin
    volumes:
      - ./dags:/opt/airflow/dags
      - ./logs:/opt/airflow/logs
      - ./plugins:/opt/airflow/plugins
      - ./config:/opt/airflow/config
      - ./requirements.txt:/opt/airflow/requirements.txt
      # 挂载本地股票数据目录 (用于 Backtrader 和 QLib)
      - D:\JoinQuant\VScode\starquant4-factor\stockdata:/opt/airflow/stockdata
    ports:
      - "8080:8080"
    command: standalone
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped
