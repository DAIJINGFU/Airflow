<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Airflow ç™»å½•æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-left: 4px solid #007bff;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      code {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ Airflow 3.1.3 ç™»å½•è¯Šæ–­å·¥å…·</h1>

      <div class="test-section">
        <h3>ğŸ“‹ å½“å‰ç™»å½•å‡­æ®</h3>
        <p><strong>ç”¨æˆ·å:</strong> <code>admin</code></p>
        <p>
          <strong>å¯†ç :</strong>
          <code id="currentPassword">SNZ5mDTmNdBDT2bS</code>
        </p>
        <p>
          <strong>ç™»å½•åœ°å€:</strong>
          <code
            ><a href="http://localhost:8080" target="_blank"
              >http://localhost:8080</a
            ></code
          >
        </p>
      </div>

      <div class="test-section">
        <h3>ğŸ§ª æµ‹è¯• 1: API Token è®¤è¯</h3>
        <button onclick="testAPILogin()">æµ‹è¯• API ç™»å½•</button>
        <div id="apiResult" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ§ª æµ‹è¯• 2: è¡¨å•ç™»å½•</h3>
        <input
          type="text"
          id="username"
          placeholder="ç”¨æˆ·å"
          value="admin"
          style="margin: 5px; padding: 8px"
        />
        <input
          type="password"
          id="password"
          placeholder="å¯†ç "
          value="SNZ5mDTmNdBDT2bS"
          style="margin: 5px; padding: 8px"
        />
        <button onclick="testFormLogin()">æµ‹è¯•è¡¨å•ç™»å½•</button>
        <div id="formResult" class="result" style="display: none"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ’¡ æµè§ˆå™¨é—®é¢˜æ’æŸ¥æ­¥éª¤</h3>
        <ol>
          <li>
            <strong>æ¸…é™¤ç¼“å­˜å’Œ Cookie:</strong>
            <ul>
              <li>æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·</li>
              <li>Application (åº”ç”¨ç¨‹åº) â†’ Storage â†’ Clear site data</li>
              <li>æˆ–è€…ä½¿ç”¨éšç§/æ— ç—•æ¨¡å¼</li>
            </ul>
          </li>
          <li>
            <strong>ç¡¬åˆ·æ–°é¡µé¢:</strong>
            <ul>
              <li>
                Windows: <code>Ctrl + F5</code> æˆ– <code>Ctrl + Shift + R</code>
              </li>
              <li>Mac: <code>Cmd + Shift + R</code></li>
            </ul>
          </li>
          <li>
            <strong>æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°:</strong>
            <ul>
              <li>æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·</li>
              <li>æŸ¥çœ‹ Console æ ‡ç­¾çš„é”™è¯¯ä¿¡æ¯</li>
              <li>æŸ¥çœ‹ Network æ ‡ç­¾çš„è¯·æ±‚çŠ¶æ€</li>
            </ul>
          </li>
          <li>
            <strong>å°è¯•å…¶ä»–æµè§ˆå™¨:</strong>
            <ul>
              <li>Chromeã€Edgeã€Firefox ç­‰</li>
            </ul>
          </li>
        </ol>
      </div>

      <div class="test-section">
        <h3>ğŸ” å¿«é€Ÿè¯Šæ–­</h3>
        <button onclick="clearLocalData()">æ¸…é™¤æœ¬åœ°å­˜å‚¨</button>
        <button onclick="window.location.reload(true)">ç¡¬åˆ·æ–°é¡µé¢</button>
        <button onclick="window.open('http://localhost:8080', '_blank')">
          æ‰“å¼€ Airflow (æ–°æ ‡ç­¾)
        </button>
        <div id="diagResult" class="result info" style="display: block">
          <strong>æç¤º:</strong> ç‚¹å‡»"æ¸…é™¤æœ¬åœ°å­˜å‚¨"åå†ç‚¹å‡»"æ‰“å¼€
          Airflow"å°è¯•ç™»å½•
        </div>
      </div>
    </div>

    <script>
      async function testAPILogin() {
        const resultDiv = document.getElementById("apiResult");
        resultDiv.style.display = "block";
        resultDiv.className = "result info";
        resultDiv.innerHTML = "æ­£åœ¨æµ‹è¯•...";

        try {
          const response = await fetch("http://localhost:8080/auth/token", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: "admin",
              password: document.getElementById("currentPassword").textContent,
            }),
          });

          if (response.ok) {
            const data = await response.json();
            resultDiv.className = "result success";
            resultDiv.innerHTML = `
                        <strong>âœ… API ç™»å½•æˆåŠŸï¼</strong><br>
                        Token (å‰50å­—ç¬¦): <code>${data.access_token.substring(
                          0,
                          50
                        )}...</code><br>
                        <br><strong>ç»“è®º:</strong> API è®¤è¯æ­£å¸¸ï¼Œé—®é¢˜å¯èƒ½åœ¨æµè§ˆå™¨ç«¯ä¼šè¯ç®¡ç†ã€‚
                    `;
          } else {
            resultDiv.className = "result error";
            resultDiv.innerHTML = `
                        <strong>âŒ API ç™»å½•å¤±è´¥</strong><br>
                        çŠ¶æ€ç : ${response.status}<br>
                        é”™è¯¯: ${response.statusText}
                    `;
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `
                    <strong>âŒ è¯·æ±‚å¤±è´¥</strong><br>
                    é”™è¯¯: ${error.message}<br>
                    <br><strong>å¯èƒ½åŸå› :</strong> å®¹å™¨æœªå¯åŠ¨æˆ–ç«¯å£æœªæ˜ å°„
                `;
        }
      }

      async function testFormLogin() {
        const resultDiv = document.getElementById("formResult");
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        resultDiv.style.display = "block";
        resultDiv.className = "result info";
        resultDiv.innerHTML = "æ­£åœ¨æµ‹è¯•...";

        try {
          const response = await fetch("http://localhost:8080/auth/token", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              password: password,
            }),
          });

          if (response.ok) {
            const data = await response.json();
            // å°è¯•ä½¿ç”¨ token è®¿é—®å—ä¿æŠ¤èµ„æº
            const testResponse = await fetch(
              "http://localhost:8080/ui/config",
              {
                headers: {
                  Authorization: `Bearer ${data.access_token}`,
                },
              }
            );

            if (testResponse.ok) {
              resultDiv.className = "result success";
              resultDiv.innerHTML = `
                            <strong>âœ… å®Œæ•´ç™»å½•æµç¨‹æµ‹è¯•æˆåŠŸï¼</strong><br>
                            1. Token è·å–æˆåŠŸ<br>
                            2. Token éªŒè¯æˆåŠŸ<br>
                            3. API è®¿é—®æ­£å¸¸<br>
                            <br><strong>å»ºè®®:</strong> æ¸…é™¤æµè§ˆå™¨ç¼“å­˜åè®¿é—® <a href="http://localhost:8080" target="_blank">Airflow UI</a>
                        `;
            } else {
              resultDiv.className = "result error";
              resultDiv.innerHTML = `
                            <strong>âš ï¸ Token è·å–æˆåŠŸä½†éªŒè¯å¤±è´¥</strong><br>
                            è¿™å¯èƒ½æ˜¯æµè§ˆå™¨ä¼šè¯é—®é¢˜
                        `;
            }
          } else {
            resultDiv.className = "result error";
            resultDiv.innerHTML = `
                        <strong>âŒ ç™»å½•å¤±è´¥</strong><br>
                        çŠ¶æ€ç : ${response.status}<br>
                        è¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦æ­£ç¡®
                    `;
          }
        } catch (error) {
          resultDiv.className = "result error";
          resultDiv.innerHTML = `<strong>âŒ è¯·æ±‚å¤±è´¥:</strong> ${error.message}`;
        }
      }

      function clearLocalData() {
        // æ¸…é™¤ localStorage
        localStorage.clear();
        // æ¸…é™¤ sessionStorage
        sessionStorage.clear();
        // å°è¯•æ¸…é™¤ cookies (ä»…é™åŒæº)
        document.cookie.split(";").forEach(function (c) {
          document.cookie = c
            .replace(/^ +/, "")
            .replace(
              /=.*/,
              "=;expires=" + new Date().toUTCString() + ";path=/"
            );
        });

        const diagResult = document.getElementById("diagResult");
        diagResult.className = "result success";
        diagResult.innerHTML = "âœ… æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤ï¼ç°åœ¨å¯ä»¥å°è¯•ç™»å½• Airflowã€‚";

        setTimeout(() => {
          diagResult.className = "result info";
          diagResult.innerHTML =
            '<strong>æç¤º:</strong> æœ¬åœ°å­˜å‚¨å·²æ¸…é™¤ï¼Œç‚¹å‡»"æ‰“å¼€ Airflow"å°è¯•ç™»å½•';
        }, 3000);
      }
    </script>
  </body>
</html>
